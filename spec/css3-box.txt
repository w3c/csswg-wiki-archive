====== CSS Box Module Level 3 ======

The goals of the CSS3 Box spec are to rewrite the CSS2.1 box model such that it is:

  * more understandable (better organization and clearer prose)
  * more precise (defines vague or missing concepts from CSS2.1, defines undefined concepts from CSS2.1)
  * generalized to handle vertical text (See CSS Writing Modes module)

This page is to track specifically the remaining work on the CSS Box module. Please post issues to [[http://lists.w3.org/Archives/Public/www-style/|www-style]] first for discussion, then add a summary and a link to the discussion and/or any key messages below.

====== General Problems to Solve ======

This section is for describing general problems that the CSS Box module must solve, e.g. concepts that need defining or refining, or spec areas that should be rewritten to improve clarity.

=====Containing blocks=====

We have seen frequent cases of spec authors using incorrect terminology or awkward constructions when referring to containing blocks, due to the lack of clarity and suitable hooks in CSS21:

  * "each element that is a containing block for the given element"
Problem: a containing block is a rectangle, not an element or box \\
Problem: a containing block is associated to a box, not to an element \\
Problem: a containing block is established by a box, not by an element

  * "Some values of these properties result in the creation of a containing block"
  * "Note that such an element is always a containing block."
Problem: not every rectangle that could //potentially// be a containing block for some box is actually a containing block for an actual box in the formatting structure

  * "The containing block of an element with 'position: absolute' is determined as specified in CSS 2.1, except that an ancestor element with 'transform' other than 'none' is treated the same as one with a 'position' of 'absolute', 'fixed', or 'relative'."
Problem: difficulty in inserting new rules to modify how the containing block of a box with particular properties is determined

  * "Flex containers form a containing block for their contents exactly like block containers do"
  * "Column boxes act as the containing block for their content. That is, column boxes behave like block-level, table cell, and inline-block boxes as per CSS 2.1, section 10.1, item 2 [CSS21]. However, column boxes do not establish containing blocks for elements with ‘position: fixed’ or ‘position: absolute’."
Problem: difficulty in restricting attention to only those boxes for whom the container will establish the containing block \\
Problem: difficulty in removing boxes from the set of potential containing block–establishing boxes for a given kind of box.


=====Anonymous boxes=====

What, really, is an anonymous box?  There currently seem to be two rather different interpretations:

  * a "fix-up" box, ie a box inserted into the formatting structure in order to ensure that content which participates in a given formatting context is grouped in such a way that it obeys the requirements of that formatting context
  * a box that cannot be addressed with CSS selectors

===Potential candidates for "anonymous" status===

  * obvious fix-up boxes:
    * block boxes and inline boxes generated to ensure that block container boxes contain no "loose" content
    * boxes generated to ensure a sensible table structure in a table formatting context
    * flex-item boxes generated to group "loose" text in a flex formatting context
    * grid-item boxes generated to group "loose" text in a grid formatting context
  * boxes which are necessarily generated for an element (depending on its property values) irrespective of its content:
    * marker box of a list item
    * table wrapper box / table box of a table element
    * column box(es) of a multicol element
    * ruby boxes (?)
  * other:
    * region flow content box

===Relevant quotes===

From CSS21:
  * "since anonymous boxes are not part of the document tree, they are not counted when calculating the first child." (:first-child pseudo-class)
  * "inheritance follows the document tree and is not intercepted by anonymous boxes"
  * "The properties of anonymous boxes are inherited from the enclosing non-anonymous box. Non-inherited properties have their initial value."
  * "Anonymous block boxes are ignored when resolving percentage values that would refer to it: the closest non-anonymous ancestor box is used instead. For example, if the child of the anonymous block box inside the DIV above needs to know the height of its containing block to resolve a percentage height, then it will use the height of the containing block formed by the DIV, not of the anonymous block box."
  * "The latter are called anonymous inline boxes, because they do not have an associated inline-level element"
  * "anonymous inline boxes inherit inheritable properties from their block parent box. Non-inherited properties have their initial value."

From css3-images:
  * "Objects inserted via the CSS2.1 ‘content’ property are anonymous replaced elements, and are sized the same way. [CSS21] Note that such anonymous elements have all their non-inherited properties (including ‘width’, ‘height’, etc.) set to their initial values."

===Observations===

  * The inheritance mechanism works on document tree elements, not psuedo-elements or boxes, and hence the fact that it ignores certain boxes is obvious, and doesn't even need to be stated in CSS21.  This fact is red herring when it comes to defining anonymous boxes.
  * That an anonymous box can't be selected (eg by :first-child) seems to be a design pattern rather than part of the definition of anonymous box.
  * Even if a box can't be selected right now, it may well become possible to select it in future using a pseudo-element.

===Current thinking===

I think the whole concept of anonymous boxes is unnecessary and should be removed from CSS.  Properties are set on elements, and elements generate boxes based on its properties and on the formatting context in which its contents participate.  How an element imparts its properties to the boxes that it generates is the business of that element, and I don't see that we need a special term to describe a box whose property values all arise in some particular way.  For example, I see no difference between the way that a table element distributes its property values between the wrapper box and the table box and the way that a block element distributes its properties to a so-called anonymous box; inheritable properties are inherited down the box tree (although CSS doesn't state that explicitly anywhere) and non-inheritable properties get their values from somewhere as defined by the element "type".

If the definition of principal box is modified so that an inline element generates a principal box (possibly fragmented across multiple line boxes), then perhaps we can define an anonymous box to be any box which is not a principal box.  In that case, "derived box" might be a better term since such a box might not be anonymous in the sense that there may well exist a selector which can directly address some properties of that box (eg table element selector which addresses the table box, list item selector which addresses the marker box or even a ::marker pseudo-element).


====== Spec Issues ======

This section is for listing errors in the spec and mismatches against CSS2.1.
