==== Regions: Processing Model for height:auto ====

This page documents a possible processing model for enabling height:auto on regions. 
This is a work in progress and meant to help discussion and drive to an agreed upon model.

Regions layout multiple boxes:
  * generated content boxes (::before and ::after)
  * RFCB: Region Flow Content Box (the box which lays out the fragment of content associated with the region's named flow).
  
In the following, 'intrinsic height' refers to the used height of the fragment of content inside of the RFCB.

=== Multi-Step processing model ===

The model for regions is to layout in at most two steps. Each step has two phases (conceptually):

  * Phase 1. Region layout. In this step, regions are laid out according to the normal CSS box model. No content is flowed into the regions.
  * Phase 2. Flow layout. In this step, content is flowed into the regions laid out in Step 1.

Step A : Initial Layout

Phase 1.

In all cases, regions are laid out with a first step where regions which have a computed value of height:auto, resolve their region's used height based on an RFCB's used height of zero (because the 'intrinsic height' cannot be computed yet). The used height resolves to zero assuming a default min-height/max-height and no generated content. The used height may resolve to something else: for example, if the min-height is 300px and there is no generated content, the used height will resolve to 300px.

Phase 2.

In Step A, if a region has as computed height of auto, then the user agent does the following:

  - compute the 'intrinsic height' of the RFCB of the region based on the region's width and the remainder of the flow taking into account fragmentation rules and the max-height of the current region.

Step B : Optional Layout

If the regions' used height computation depends on the RFCB's 'intrinsic height', then a new two-phase step happens (Step B) where the region layout happens and uses the 'intrinsic heights' for RFCBs computed in Step A.

=== Optimizations ===

Even though the model contains up to two steps with two phases each, implementations can typically optimize 
this model and implement the layout in fewer iterations.

=== Examples ====

== Example A ==

<code>
<style>
#article {
    flow-into: article;
}

#regionA {
     width: 300ex;
     height: auto;
     flow-from: article;
}

</style>

<div id="article">…</div>
<div id="regionA"></div>
</code>

  - Step A, Phase 1: layout regionA. regionA uses an intrinsic height of zero.
  - Step A, Phase 2: layout content in regions. When laying out regionA with height:auto: 
                      - compute the fragment that fits into the region (following fragmentation rules) in the specified width of 300ex.
                      - compute the intrinsic height of the region based on the fragment content
                      - freeze the intrinsic height ('Y') for regionB. **[QUESTION: what is regionB?]**
                      
Because there is a region with height:auto, a Step B is necessary. 

  - Step B, Phase 1: layout regionA. regionA uses an intrinsic height of 'Y'. 
  - Step B, Phase 2: layout content in region. 
          
== Example B - Edge Case B (from https://www.w3.org/Style/CSS/Tracker/actions/351) ==

<code>
   <div style="display:flexbox">
      <div id="region1" style="flow-from:x; flex:2"></div>
      <div id="region2" style="flow-from:x; flex:1"></div>
   </div>
</code>  

  - Step A, Phase 1: layout region1 and region2 using an intrinsic height of 0. 
  - Step A, Phase 2: layout content in regions. Because region1 has height:auto, 
                      - compute the fragment that fits into the region (following fragmentation rules). 
                      - compute the intrinsic height of the region based on the fragment content
                      - freeze the intrinsic height ('Y') for region1.
     Because region2 has height:auto:
                      - compute the fragment that fits into the region (following fragmentation rules). Depending on what the fragment rules determined fit into region1 there may not be content remaining in the flow. **[QUESTION: assuming no explicit breaks why would there be any content left from regions1? The intrinsic height will be simply all of the flow's content...]**
                      - compute the intrinsic height of the region based on the fragment content
                      - freeze the intrinsic height ('Z') for region2.
                      
Because there is a region with height:auto, a Step B is necessary. 

  - Step B, Phase 1: layout region1 and region2. region1 uses an intrinsic height of 'Y', region2 uses an intrinsic height of 'Z'. 
  - Step B, Phase 2: layout content in region. 
         
== Example C - Edge Case A (from https://www.w3.org/Style/CSS/Tracker/actions/351) ==
<code>
<style>
    #regionA {
        top: 0;
        bottom: 0;
        width: 100px;
        position: absolute;
        flow-from: article;
    }
    
    #regionB {
        flow-from: article;
        width: 200px;
        margin-left: 120px;
        top: 0;
        right: 0;
        position: absolute;
    }
    
    #article {
        flow-into: article;
    }
    
</style>

<div id="article">…</div>
<div id="container" style="position:relative">
    <div id="regionA"></div>
    <div id="regionB"></div>
</div>
</code>
**[OBSERVATION: If you follow the rules of CSS 2.1 ch 10. the used size of absolutely positioned elements with height: auto; top:0px; bottom: 0px; will be the height of the containing block minus MBP, thus, this problem is practically non-existent]**
  - Step A, Phase 1: layout regionA and regionB. regionB uses an intrinsic size of zero and, as a result, regionB's top and bottom compute to 0 and has a height of zero as well.
  - Step A, Phase 2: layout content in regions. When laying out regionB, because regionB has height:auto: 
                      - compute the fragment that fits into the region (following fragmentation rules). 
                      - compute the intrinsic height of the region based on the fragment content
                      - freeze the intrinsic height ('Y') for regionB.
                      
Because there is a region with height:auto, a Step B is necessary. 

  - Step B, Phase 1: layout regionA and regionB. regionB uses an intrinsic height of 'Y'. As a result, 
                     regionA's bottom property's used value is 'Y'.
  - Step B, Phase 2: layout content in region. The content will fit partially in regionA (because it has a narrower width)
                     but will not fill in regionB completely.
                     
                     
== Example D: Multi-column region with height:auto ==

<code>
<style>
#article {
   flow-into: article;
}

#regionA, #regionB {
   flow-from: article;
}

#regionA {
   height: auto;
   column-count: 2;
}

#regionB {
   height: auto;
   column-count: 2;
}
</style>

<div id="article">...</div>
<div id="regionA"></div>
<div id="regionB"></div>
</code>

  - Step A, Phase 1: layout regionA and regionB. Both use an intrinsic height of zero.
  - Step A, Phase 2: layout content in regions. When layout region A, because region A has height:auto:
                        - compute the fragment that fits into the region (following fragmentation rules).
                        - compute the intrinsic height of the region based on the fragment content
                        - freeze the intrinsic height ('Y') for region A. **[QUESTION: are you talking about 'used height' is all of these cases?]**
                      layout content in regionB as well, and because region B has height:auto
                        - compute the fragment that fits into the region,
                        - compute the intrinsic height of the region based on the fragment content
                        - freeze the intrinsic height ('Z') for region B.


  - Step B, Phase 1: layout regionA and regionB using the intrinsic heights of 'Y' and 'Z' respectively.
  - Step B, Phase 2: layout content in regionA and B.
                      