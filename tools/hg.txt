====== Quick Guide to Using Mercurial ======

The CSS Working Group has adopted Mercurial as the repository technology for storing our test suites. Mercurial is a modern, distributed version control system. This guide is intended to serve as a quick start for those setting up access to the repository for the first time, not to serve as an in-depth tutorial. It is expected that the reader have some familiarity with centrally managed version control systems like CVS or Subversion.

===== What is a "distributed" version control system? =====

A standard version control system has a single central repository, usually hosted on a server. Users "checkout" files from the central server, make changes, and "commit" them back to the server. Users keep a working copy of the files on their own system, but all the revision history lives in the central repository.

With a distributed version control system, every user has their own repository, complete with the entire revision history. In fact, they can have as many copies of the repository as they want. Users can add or change files and commit them to their own repository at will, even without access to a central server at the time. When users are ready to share their work with others, they "push" their changes from their own repository to a central server. When they want to see others' work, they "pull" changes from the central server to their own repository.

===== Getting Started =====

==== Installing Mercurial ====

First, you'll need a Mercurial client. If you don't already have one installed, you can find [[tools:hg:install|installation instructions here]].

You can see if you already have Mercurial installed by opening up a command shell and typing "hg %%--%%version". Our server is running version 2.1, earlier versions should work, but we recommend using the latest client.

The remainder of this guide will focus on the command-line Mercurial client "hg", but there are GUI-based Mercurial clients available for many platforms. Here is a [[http://mercurial.selenic.com/wiki/OtherTools|list of other Mercurial clients]]. While users of a GUI client obviously won't be using the command line, the same basic operations apply.  

==== Setting up Mercurial Preferences ====

You can store basic settings for Mercurial in your config file. [[http://www.selenic.com/mercurial/hgrc.5.html|Detailed instructions for the config file]] are available, but for now, this guide will focus only on setting up the basics.

In your favorite plain text editor, create a file named ".hgrc" in your home directory and enter the following:

  [ui]
  username = Your Full Name <your@email.address.example>
  merge = internal:merge
  editor = your_favorite_text_editor # optional -- defaults to $EDITOR or vi
  
  [diff]
  git = 1
  showfunc = 1
  unified = 8
  
  [defaults]
  commit = -v

  [auth]
  # CSSWG Test Repository
  csswg.prefix = https://hg.csswg.org/
  csswg.username = your_csswg.org_username
  csswg.password = your_csswg.org_password #optional

  # CSSWG Spec Repository
  w3c.prefix = https://dvcs.w3.org/hg/
  w3c.username = your_w3.org_username
  w3c.password = your_w3.org_password #optional

**IMPORTANT**: If you will be pushing changes to the CSSWG Test Repository, and you use the Full Name <email> format, be sure the email address you enter is the same as that associated with your wiki account. Alternatively, replace
  username = Your Full Name <your@email.address.example>
with
  username = your_csswg.org_username

<note>
**Avoiding Password Requests**

Putting your password into ''.hgrc'' will prevent the server from asking your username and password every time you push. If you don't want to store your password in the config file, you can [[http://mercurial.selenic.com/wiki/KeyringExtension|install the Keyring extension]] and omit the password line. The Keyring extension will prompt you for your password the first time it is needed and store it securely in your system keyring.
</note>

If you access the web through a proxy, you'll also need to set that up now. [[http://www.selenic.com/mercurial/hgrc.5.html#http-proxy|Details of proxy settings can be found here]].

==== Initial clone of the repository ====

The first step is to clone the central repository to your own machine.

  ; CSSWG Test Repository :
  hg clone https://hg.csswg.org/test
  ; CSSWG Spec Repository :
  hg clone https://dvcs.w3.org/hg/csswg/
  ; FXTF Spec Repository :
  hg clone https://dvcs.w3.org/hg/FXTF/

Note: By default, the directory name will match the one on the server. If you want to use a different name, enter it at the end of the command.

Once this command is complete, you now have your very own copy of the repository. You can begin making changes at will.

===== Working With Mercurial =====

==== Resyncing Your Repository: hg pull ====

You can resync your copy of the repository with the central copy by pulling:

  hg pull -u

FIXME Explain how to identify and deal with conflicts.

If you have committed changes that you haven't yet pushed to the server, you may need to merge. See below.

==== Listing Changed Files ====

While you are working, you can see an overview of your changes by entering:
  hg status   # all files in the repository
  hg status . # only files in this directory

This command will give a list of files that differ from the current state of your repository. Modified files will have an "M" listed before their name, new files will have a "?", missing files will have a "!".

==== Diffs and Patches ====

You can also see the actual changes you've made by asking for a diff:
  hg diff   # all files in the repository
  hg diff . # only files in this directory

You can create a patch file by redirecting to a file: Append '' > filename.patch'' to the diff command, e.g.
  hg diff > filename.patch

===== Managing Files =====

==== Adding new files: hg add ====

If you create a new file or directory, you'll need to tell Mercurial to start tracking it. You do this by the following:
  hg add filename

Adding a directory recursively adds all of its contents.

Once you add a file it'll show up in the status listing with an "A". Note that newly added files aren't actually in the repository until you commit them. If you omit the filename, all unknown files and directories in the current directory are added.

==== Removing files: hg remove ====

To remove a file from the repository type:
  hg remove filename
  
Once a file is removed, it'll show up in the status listing with a "R". The file is removed from your working directory immediately, but it isn't removed from the repository until your next commit.

==== Reverting changes: hg revert ====

If you decide you don't want to keep changes you made to a file, or removed a file by mistake, you can restore to the last committed version by typing:
  hg revert filename

===== Submitting Changes =====

Note: Before you submit your changes, it's a good idea to review them by getting a diff.

When you're sure you want to push to the server, **first make sure you pull again**, then commit and push your changes. Like this:

  hg pull -u
  hg merge
  hg commit -m "Commit message explaining your changes"
  hg push

If there's a conflict after you pull, make sure you fix it before you continue with the merge!

<note important>
By default, //all// modified, added or removed files will be committed into your repository, not just those in the current directory.

You can commit individual files by specifying their names at the end of the ''hg commit'' command. You can use ''.'' to commit all changes in the current directory, e.g.
  hg commit -m "Fix all typos in this directory" .
</note>

At this point your changes will be available on the server to other users.

If you received an error message about "heads", you likely forgot to pull, update and merge/rebase before pushing (or someone else pushed just before you). The error message describes re-trying the push with the "-f" option to force it working. DON'T DO THIS. Doing this would create a branch in the central repository. Pull, merge, commit, then try the push again. See the section above about merging.

If you have a long commit message, you can leave out the ''-m "Commit message"'' part and Mercurial will fire up the editor you mentioned in your config file.

==== Merging ====

When you pull, if you have committed changes to your repository, and others have pushed changes to the central repository, Mercurial automatically creates a branch to track the different lines of work. You'll know this happened if you see a message like:
  added 2 changesets with 1 changes to 1 files (+1 heads)
  (run 'hg heads' to see heads, 'hg merge' to merge)

What this means is that you have to merge other people's changes into your work before you can push back to the central repository. This is the same operation you would do with a centrally managed version control system like Subversion during an update. The difference with Mercurial is that the other changes are tracked separately from yours and you can merge when you're ready.

When you're ready to merge, simply type:
  hg merge

In most cases Mercurial will be able to handle the merge completely by itself. If both you and others have changed the same area in the same files, there may be a conflict.

<note>
You can also [[http://mercurial.selenic.com/wiki/MergeProgram|select a merge program]] in place of "internal:merge" in your ''.hgrc''. The merge program will help you resolve conflicts between your work and others' after pulling from the central repository. If you select "internal:merge", Mercurial will leave conflict markers in your source similar to Subversion or other systems.
</note>

Once the merge is complete (and you've resolved any conflicts), you'll need to commit it.

==== Advanced: Offline Commits ====

Mercurial allows you to commit changes to your local copy of the repository, allowing you to save your work in stages (and assign separate commit messages to each stage) without communicating with the central server. This is why ''hg commit'' and ''hg push'' are separate commands. Note that if you do this, you'll need to get comfortable with ''hg merge'' and/or ''hg rebase''.

===== CVS / Subversion Cheat Sheet =====

If you are used to using Subversion or CVS, the following commands are roughly equivalent:

  cvs update  == svn update  ==  hg pull --update  or  hg pull ; hg merge
  cvs commit  == svn commit  ==  hg commit ; hg push
     ???      == svn status  ==  hg status
  cvs diff -u == svn diff    ==  hg diff
  cvs add     == svn remove  ==  hg add
  cvs remove  == svn remove  ==  hg remove
  
Of course, there's a lot more to Mercurial, but that's beyond the scope of this document.

===== Wait, I had work that I didn't commit in the old CVS/Subversion repository =====

We recently moved to Mercurial. If you had been working on a checkout from the old CVS or Subversion repository and hadn't committed your changes before the move, the best way forward is to clone a new Mercurial repository in a different directory, then copy your added or changed files from your old working directory into your new Mercurial working directory, then commit and push from there.

===== More Information =====

There are many more in-depth guides to Mercurial available on the web, here are a few:
  * [[http://hginit.com|Hg Init: a Mercurial tutorial by Joel Spolsky]]
  * [[http://hgbook.red-bean.com/|Mercurial: The Definitive Guide]]
  * [[http://mercurial.selenic.com/|Mercurial Project Home Page]]

===== Still need help? =====

If you're stuck, you can [[mailto:peter.linss@hp.com|email Peter]] for help with the repository.

Also, remember, this is a wiki. If you can improve these instructions, please do.
